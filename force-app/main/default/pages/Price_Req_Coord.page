<apex:page controller="Price_Req_Coord_Controller"  id="thepage" sidebar="false" standardstylesheets="false">

<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery-1.8.3.min.js')}" type="text/javascript"/> 
<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery-ui-1.9.2.custom.js')}" type="text/javascript"/>
<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery.mobile.events.js')}" type="text/javascript"/>
<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery.dataTables.js')}" type="text/javascript"/>
<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery-ui.toggleSwitch.js')}" type="text/javascript"/>
<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery.sortElements.js')}" type="text/javascript"></script>
<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery.dataTables.extensions.js')}" type="text/javascript"></script>
<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery.tooltip.js')}" type="text/javascript"></script>
<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery.multiselect.min.js')}" type="text/javascript"/> 
<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery.multiselect.filter.js')}" type="text/javascript"/>
<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery.validate.js')}" type="text/javascript"/>
<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery.form.js')}" type="text/javascript"/>
<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery.bbq.js')}" type="text/javascript"/>
<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery.form.wizard.js')}" type="text/javascript"/>
<script src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/js/jquery.easyui.min.js')}" type="text/javascript"></script>


<apex:stylesheet value="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/themes/default/easyui.css')}"/>  
<apex:stylesheet value="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/css/jquery.tooltip.css')}"/>
<apex:stylesheet value="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/css/start/jquery-ui-1.10.1.custom.min.css')}"/>
<apex:stylesheet value="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/css/demo_table.css')}"/> 
<apex:stylesheet value="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/themes/default/easyui.css')}"/>    
<apex:stylesheet value="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/themes/icon.css')}"/> 
<apex:stylesheet value="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/themes/default/menu.css')}"/>
<apex:stylesheet value="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/themes/default/menubutton.css')}"/>
<apex:stylesheet value="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/themes/default/splitbutton.css')}"/>
<apex:stylesheet value="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/themes/icon.css')}"/>
<apex:stylesheet value="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/css/jquery-ui.toggleSwitch.css')}"/> 
<apex:stylesheet value="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/css/jquery.multiselect.css')}"/> 
<apex:stylesheet value="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/css/jquery.multiselect.filter.css')}"/> 
<script  src="/soap/ajax/25.0/connection.js" type="text/javascript"></script>
<script  src="/soap/ajax/25.0/apex.js" type="text/javascript"></script>


<apex:outputpanel id="scriptpanel">
<script type="text/javascript" charset="utf-8">
    
    var aColumnIndex = new Array();
    var oTable;
    var saveflag = 'True';
    function fnGetColumnIndex(oSettings){
        var aColumns = new Array();
        $.each(oSettings.aoColumns, function(c){
            var mData = oSettings.aoColumns[c].sClass
                aColumns[mData] = c;
        });
        return aColumns;
    
    }
    function fnFormatDetails ( oTable, nTr )
    {
        var oSettings = oTable.fnSettings();
        var aData = oTable.fnGetData( nTr );
        var sDecoded = $('<div/>').html(aData.Inner_Table__c).text();
       // var sOut = sDecoded.replace(/\+/g,' ');
        return sDecoded;
    }
    
    function fixEscapedHTML(html, fieldid) {
        var value = $("<div />").html(html).text();
        setTimeout(function(){ $('#' + fieldid).combogrid('textbox').val(value);}, 10)
    }
          
             
    $(document).ready(function() { 
        
         $('#ClearFilters').click(function(){ 
           $('#pendingentry').find('.textinput, .selectinput').each(function(i, ti){ $(this).val($(this).attr('name')); 
              $('#pendingentry').dataTable().fnFilter('', aColumnIndex[$(this).attr('data-field')]);
           });
           $('#pendingentry').find('.dateinputfrom, .dateinputto, .numberinputfrom, .numberinputto').each(function(){
            $(this).val($(this).attr('name')); 
           }); 
           $('#pendingentry').dataTable().fnDraw();
         });
         
        
        $('#pendingentry').dataTable({
                "bDestroy": true,
                "sPaginationType": "four_button",
                "fnDrawCallback": function( oSettings ) {
                   $('.row_selected').removeClass('row_selected');
                 },
                "bSort": true,
                "sErrMode": false,
                "sDom": 'lfrtip',
                "bAutoWidth": false,
                
                "aoColumnDefs": [
                    { "aTargets":[ "Open"], sClass:"Open" ,sWidth:"2px", "bAutoWidth": false},
                    { "aTargets":[ "Select"], sClass:"Select", sWidth:"2px", "bAutoWidth": false },
                    { "aTargets":[ "Transaction" ], "mData": "Name", sClass:"Name",sWidth:"2px", "bAutoWidth": false },
                    { "aTargets":[ "Corporate_Owner" ], "mData": "Ship_To__r.SAP_Corporate_Account_Manager__r.Name", sClass:"Ship_To__r.SAP_Corporate_Account_Manager__r.Name",sWidth:"2px", "bAutoWidth": false },
                    { "aTargets":[ "Corporate" ], sClass:"SAP_Corporate_Account__c",sWidth:"2px", "bAutoWidth": false, 
                      "mData": function ( source, type, val ) {
                          if (type === 'set') {
                              return;
                          }
                          else if (type === 'display' || type === 'filter') { return source.SAP_Corporate_Account__c;}
                          else if (type === 'sort') { return source.Corporate_Account_Number__c; }
                          return source.SAP_Corporate_Account__c;
                      }
                    },
                    { "aTargets":[ "Sold_To" ], sClass:"SAP_SoldTo_Account__c",sWidth:"2px", "bAutoWidth": false, 
                      "mData": function ( source, type, val ) {
                          if (type === 'set') {
                              return;
                          }
                          else if (type === 'display' || type === 'filter') { return source.SAP_SoldTo_Account__c;}
                          else if (type === 'sort') { return source.Sold_To_Account_Number__c; }
                          return source.SAP_SoldTo_Account__c;
                      }
                    },
                    { "aTargets":[ "Ship_To" ], sClass:"SAP_ShipTo_Account__c",sWidth:"2px", "bAutoWidth": false, 
                      "mData": function ( source, type, val ) {
                          if (type === 'set') {
                              return;
                          }
                          else if (type === 'display' || type === 'filter') { return source.SAP_ShipTo_Account__c;}
                          else if (type === 'sort') { return source.Ship_To_Account_Number__c; }
                          return source.SAP_ShipTo_Account__c;
                      }
                    },
                    { "aTargets":[ "Sales_Org" ], sClass:"Sales_Org_Code_and_Desc__c",sWidth:"2px", "bAutoWidth": false, 
                      "mData": function ( source, type, val ) {
                          if (type === 'set') {
                              return;
                          }
                          else if (type === 'display'  || type === 'filter') { return source.Sales_Org_Code_and_Desc__c;}
                          else if (type === 'sort') { return source.Ship_To_Sales_Org__c; }
                          return source.Sales_Org_Code_and_Desc__c;
                      }
                    },
                    { "aTargets":[ "Sales_Group" ], "mData": "Ship_To__r.SAP_Sales_Group_Desc__c", sClass:"Ship_To__r.SAP_Sales_Group_Desc__c",sWidth:"2px", "bAutoWidth": false },
                    { "aTargets":[ "Ship_To_Seller" ], "mData": "Ship_To__r.Owner.Name", sClass:"Ship_To__r.Owner.Name",sWidth:"2px", "bAutoWidth": false },
                    { "aTargets":[ "Material" ], "mData": "SAP_Material__r.Name", sClass:"SAP_Material__r.Name",sWidth:"2px", "bAutoWidth": false },
                    { "aTargets":[ "Eff_Date" ], sClass:"Requested_Effective_Date__c",sWidth:"2px", "bAutoWidth": false,
                      "mData": function ( source, type, val ) {
                          if (type === 'set') {
                              return;
                          }
                          else if (type === 'display' || type== 'filter') { return source.Requested_Effective_Date_Text__c;}
                          else if (type === 'sort') { 
                           if((typeof source.Requested_Effective_Date__c == 'undefined') || source.Requested_Effective_Date__c == null)
                              return '';
                            else 
                             return new Date(source.Requested_Effective_Date__c);
                          }
                          return source.Requested_Effective_Date__c;
                      }
                    },
                    { "aTargets":[ "Exp_Date" ], sClass:"Requested_Expiration_Date__c",sWidth:"2px", "bAutoWidth": false,
                      "mData": function ( source, type, val ) {
                          if (type === 'set') {
                              return;
                          }
                          else if (type === 'display' || type === 'filter') { return source.Requested_Expiration_Date_Text__c;}
                          else if (type === 'sort') { 
                           if((typeof source.Requested_Expiration_Date__c == 'undefined') || source.Requested_Expiration_Date__c == null)
                              return '';
                            else 
                             return new Date(source.Requested_Expiration_Date__c);
                          }
                          return source.Requested_Expiration_Date__c;
                      }
                    },
                    { "aTargets":[ "Volume" ], "mData": "Volume__c", sClass:"Volume__c",sWidth:"2px", "bAutoWidth": false },
                    { "aTargets":[ "Requested_UoM" ], "mData": "Requested_UoM__c", sClass:"Requested_UoM__c",sWidth:"2px", "bAutoWidth": false },
                    { "aTargets":[ "Price" ], sClass:"Price__c",sWidth:"2px", "bAutoWidth": false,
                    "mData": function ( source, type, val ) {
                          if (type === 'set') {
                              return;
                          }
                          else if (type === 'sort' || type === 'filter') { return source.Price__c;}
                          else if (type === 'display') { 
                           if((typeof source.Price__c == 'undefined') || source.Price__c == null)
                              return '';
                            else 
                             return source.CurrencyIsoCode + ' ' + source.Price__c;
                          }
                          return source.Requested_Expiration_Date__c;
                     }
                    
                    },
                    { "aTargets":[ "Requested_Price_UoM" ], "mData": "Requested_Price_UoM__c", sClass:"Requested_Price_UoM__c",sWidth:"2px", "bAutoWidth": false },
                    { "aTargets":[ "Requested_Price_Protection" ], "mData": "Requested_Price_Protection__c", sClass:"Requested_Price_Protection__c",sWidth:"2px", "bAutoWidth": false },
                    { "aTargets":[ "Comments" ], "mData": "Comments__c", sClass:"Comments__c",sWidth:"2px", "bAutoWidth": false },
                    { "aTargets":[ "Approval_Rejection_Comments" ], "mData": "Approval_Rejection_Comments__c", sClass:"Approval_Rejection_Comments__c",sWidth:"2px", "bAutoWidth": false },
                    { "aTargets":[ "Id" ],"mData": "Id", sClass:"Id", bVisible: false,sWidth:"2px", "bAutoWidth": false},
                    { "aTargets":[ "Inner_Table" ],"mData": "Inner_Table__c", sClass:"Inner_Table__c",sWidth:"2px", "bAutoWidth": false, "bVisible":false},
                    
                 ],
                  
                 "fnInitComplete": function(oSettings) {
                     aColumnIndex = fnGetColumnIndex(oSettings);
                  },
                  
                  
                "fnCreatedRow": function( nRow, aData, iDataIndex ) {
                    
                      $('td:eq(0)', nRow).html( '<img src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/images/details_open.png')}">');
                      $('td:eq(1)', nRow).html( '<input type="checkbox" name="Ids" class="SelectedIds" value="'+ aData.Id+'">');
                      
                      fnEvaluateTable($('#pendingentry' ).dataTable());
                      fnSetCheckboxListener(nRow, $('#pendingentry' ).dataTable());
                 },
                    
              });
        fnPrepFilters('pendingentry', aColumnIndex);
        
        
        
     $('#Reset').click(function(){
              $('#pendingentry tbody td input').removeAttr("checked");
              fnEvaluateTable($('#pendingentry' ).dataTable());
        });
     
     $('#SelectAll').click(function(){
              $('#pendingentry tbody td input').each(function(){
                      if($(this).attr("disabled") != "disabled")
                         $(this).attr("checked", "checked");
              });
              fnEvaluateTable($('#pendingentry' ).dataTable());
       });

    $('#sb1,#sb2').splitbutton({plain:false});
     
     $('#closerecords').click(function(){ 
           
          var oTable = $('#pendingentry').dataTable();
          var aaSelected = new Array();
          $('#pendingentry tr input').each(function(){ 
                if($(this).prop('checked') == true){
                    aaSelected.push($(this).val());
                }
          });
          Price_Req_Coord_Controller.CloseRecords(aaSelected,(function(result, event){ 
          if(event.type == 'exception') {
            console.log(event);
            alert(event.message);
          }else{
            oTable.fnClearTable();
            fnfetchPendingEntry();
          }
          
           }));
          
     }); 
     
       $('#rejectInfo').click(function(){
         if($('#mm1').menu('findItem', 'Update Info').disabled == false){
             var oTable = $('#pendingentry').dataTable();
             var sData = oTable.$('input:checked').serialize();
             var nSize = oTable.$('input:checked').size();
             if(nSize > 1)
                { alert('Updation is allowed for only one record at a time.'); }
             else
                { 
                  $('#loadtarget').load('/apex/Coordinator_Update_Form?'+sData, function() {
                     fnInitForm('Static'); 
                     $('#createform').ajaxForm({  
                         dataType: 'json', 
                         beforeSubmit: beforeSubmit });
                   ($('#createform').formSerialize());
                   $("#createform").validate({
                         errorPlacement: function(error, element){
                            error.insertAfter(element.parent().find('.error_container'));
                         }
                    });
                    jQuery.validator.addMethod("currency", function(value, element) { 
                      return this.optional(element) || /^([1-9]{1}[0-9]{0,2}(\,[0-9]{3})*(\.[0-9]{2,4})?|[1-9]{1}[0-9]{0,}(\.[0-9]{2,4})?|0(\.[0-9]{2,4})?|(\.[0-9]{2,4})?)$/.test(value); 
                   }, "Please enter a valid number.");
                  });
                }
           }
        });
              
        $('#rejectInfo').hide();
        $('#pendingentry tbody td img, .formtable tbody td img').live('click', function () {
            var nTr = this.parentNode.parentNode;
            oTable = $(nTr.parentNode.parentNode).dataTable();
            var iRows = oTable.fnSettings().fnRecordsTotal();
            var iHeight = oTable.fnSettings().oScroll.sY;
            if ( this.src.match('details_close') )
            {
                this.src = "{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/images/details_open.png')}";
                oTable.fnClose( nTr );
                iHeight = iHeight -125;
            }
            else
            {
                this.src = "{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/images/details_close.png')}";
                oTable.fnOpen( nTr, fnFormatDetails(oTable, nTr), 'details' ); 
                $('.innerTable').dataTable({
                "bDestroy": true,
                "bPaginate": false,
                "bLengthChange": false,
                "bFilter": false,
                "bSort": false,
                "bInfo": false
                });
                iHeight = iHeight + 125;
            }

                      if(iHeight >= 75 && iHeight < 400 && oTable.fnSettings().oScroll.sY < 400)
                      {  oTable.fnSettings().oScroll.sY = iHeight;
                         $(oTable).parent().height(iHeight);
                      }
                      if(iHeight > 400 || oTable.fnSettings().oScroll.sY > 400)
                      {
                         oTable.fnSettings().oScroll.sY = 400;
                         $(oTable).parent().height(400);
                      }
        } );
       fnfetchPendingEntry();
       if('{!$CurrentPage.parameters.Flag}' == 'True')
        {
            var oTable = $('#pendingentry').dataTable();
            oTable.fnFilter('{!$Currentpage.parameters.Name}', 2);
            $('input[data-field="Name"]').val('{!$Currentpage.parameters.Name}');
            
        }
    });
    
    function beforeSubmit(formData, jqForm, options){
        $(formData).each(function(i, data){ 
           if(data.name == 'effdate')
             data.value = Date.parse($('#edate').datepicker('getDate'));
           if(data.name == 'exdate')
             data.value = Date.parse($('#exdate').datepicker('getDate'));
        });


        startSimulate(formData, $('#formtype').val());
        return false;
    }  
        
        
    function fnfetchPendingEntry(){
      Price_Req_Coord_Controller.fetchPendingEntries(function(result, event){ 
      if(event.type == 'exception') {
           console.log(event);
           alert(event.messsage);
           
      } else { 
        if(result.length > 0)
        {        
          oTable = $('#pendingentry').dataTable();
          oTable.fnAddData(result);
          fnUpdateFilterSelect('pendingentry');
        }
       }
     });
    }
    
    function fnSetCheckboxListener(nRow, oTable){
      $(nRow).find('input:checkbox').click(function(){
          fnEvaluateTable(oTable);
      });
    }
    function fnEvaluateTable(oTable){
    
      var item = $('#mm1').menu('findItem', 'Update Info');
      var iSelected = 0;
      $(".SelectedIds").each(function(i, v){
           if($(this).attr("checked") == "checked")
           { iSelected ++;
           }      
      });
      if(iSelected == 0) 
        {   
            $('#mm1').menu('disableItem', item.target);
        }
      else
        {       
           $('#mm1').menu('enableItem', item.target);
        }
    }
    
    
        function fnUpdateFilterSelect(stableid){
            $('#' + stableid).find('.selectinput').each(function(i, sel){
            
              var val = $(sel).val();
              $(sel).empty();
              
              var opt = '<option value="' + $(sel).attr('name') + '"';
              if(val == $(sel).attr('name'))
              opt += ' selected="selected" ';
              opt += '>' + $(sel).attr('name') + '</option>';
              var arr = $('#' + stableid).dataTable().fnGetColumnData(aColumnIndex[$(sel).attr('data-field')]);
              $(arr).each(function(j, o){
                opt = opt + '<option value="' + o + '"';
                if(val == o)
                opt += ' selected="selected" ';
                opt += '>' + o + '</option>';
              });
              $(sel).append(opt);
             
            });
        }    
        function fnPrepFilters(stableid, aColIndex){
$('#' + stableid).find('.textfilter').each(function(i, f){ $(f).html('<div style="width:105px;"<input data-field="'+ $(f).attr('data-field') +'" class="textinput" value="' + $(f).html() + '" name="' + $(f).html() + '" style="width:100px;"/>') });
$('#' + stableid).find('.numberfilter').each(function(i, f){ $(f).html('<div class="numberinput" data-field="'+ $(f).attr('data-field') +'" style="width:105px;"><input data-field="'+ $(f).attr('data-field') +'" class="numberinputfrom" value="From ' + $(f).html() + '" name="From ' + $(f).html() + '" style="width:50px;"/><b>&nbsp;To&nbsp;</b><input class="numberinputto" value="To ' + $(f).html() + '" name="To ' + $(f).html() + '" style="width:50px;"/></div>') });
$('#' + stableid).find('.datefilter').each(function(i, f){ $(f).html('<div class="dateinput" style="width:155px;" data-field="'+ $(f).attr('data-field') +'"><input class="dateinputfrom" name="From ' + $(f).html() + '" value="From ' + $(f).html() + '" style="width:75px;"/><b>&nbsp;To&nbsp;</b><input class="dateinputto" value="To ' + $(f).html() + '" name="To ' + $(f).html() + '" style="width:75px;"/></div>') });
$('#' + stableid).find('.listfilter').each(function(i, f){ $(f).html('<div style="width:105px;"><select data-field="'+ $(f).attr('data-field') +'" class="selectinput" name="' + $(f).html() + '" style="width:100px;"><option selected="selected" value="' + $(f).html() + '">' + $(f).html() + '</option></select></div>') });
$( ".dateinputfrom, .dateinputto" ).datepicker({dateFormat: "yy-mm-dd", changeMonth:true, changeYear:true});
fnUpdateFilterSelect(stableid, aColIndex);
$('.selectinput').change(function(){
   $('#' + stableid).dataTable().fnFilter($(this).val(), aColIndex[$(this).attr('data-field')] );
   fnUpdateFilterSelect(stableid, aColIndex);
  });
$(".textinput").keyup( function () { $('#' + stableid).dataTable().fnFilter( this.value, aColIndex[$(this).attr('data-field')] ); fnUpdateFilterSelect(stableid, aColIndex); });
$(".numberinputfrom, .numberinputto, .dateinputfrom, .dateinputto").focus( function () { if( $(this).val() == $(this).attr('name') ){ this.value = "";}});
$(".numberinputfrom, .numberinputto, .dateinputfrom, .dateinputto").blur( function (i) { if( $(this).val() == "" ){ this.value = $(this).attr('name'); }});
$('.numberinputfrom, .numberinputto').keyup(function(){ $('#' + stableid).dataTable().fnDraw(); fnUpdateFilterSelect(stableid, aColIndex);});
$('.dateinputfrom, .dateinputto').change(function(){ $('#' + stableid).dataTable().fnDraw(); fnUpdateFilterSelect(stableid, aColIndex); });
$(".numberinput").each(function(i, ni){
  $('#' + stableid).dataTable().dataTableExt.afnFiltering.push(
    function (oSettings, aData, iDataIndex) {
                    if ($('#' + stableid).dataTable().attr("id") != oSettings.sTableId){ return true; }
                    var iMin = $(ni).find('.numberinputfrom').val();
                    var iMax = $(ni).find('.numberinputto').val();
                    var iValue = (isNaN(aData[aColIndex[$(ni).attr('data-field')]]) || aData[aColIndex[$(ni).attr('data-field')]] == null || aData[aColIndex[$(ni).attr('data-field')]] == "")? -1 : aData[aColIndex[$(ni).attr('data-field')]];
                    if ((iMin == "" || isNaN(iMin)) && (iMax == "" || isNaN(iMax))) { return true;} 
                    else if ((iMin == "" || isNaN(iMin)) && iValue <= iMax) { return true; }
                    else if (iMin <= iValue && (iMax == "" || isNaN(iMax))) { return true; }
                    else if (iMin <= iValue && iValue <= iMax) { return true; }
                    return false;
   });
});
$(".dateinput").each(function(i, di){
  $('#' + stableid).dataTable().dataTableExt.afnFiltering.push(
    function (oSettings, aData, iDataIndex) {
                    if ($('#' + stableid).dataTable().attr("id") != oSettings.sTableId){ return true; }
                    var iMin =  $(di).find('.dateinputfrom').val();
                    if(iMin !=  $(di).find('.dateinputfrom').attr('name'))
                      iMin = $(di).find('.dateinputfrom').datepicker( "getDate" );
                    var iMax =  $(di).find('.dateinputto').val();
                    if(iMax !=  $(di).find('.dateinputto').attr('name'))  
                      iMax = $(di).find('.dateinputto').datepicker( "getDate" );
                    
                    var iValue = new Date( aData[aColIndex[$(di).attr('data-field')]]);
                    if ((iMin == "" || iMin == null || iMin == $(di).find('.dateinputfrom').attr('name')) && (iMax == "" || iMax == null || iMax == $(di).find('.dateinputto').attr('name')) ) { return true;} 
                    else if ((iMin == "" || iMin == null || iMin == $(di).find('.dateinputfrom').attr('name'))  && iValue <= iMax) { return true; }
                    else if (iMin <= iValue && (iMax == "" || iMax == null || iMax == $(di).find('.dateinputto').attr('name'))) { return true; }
                    else if (iMin <= iValue && iValue <= iMax) { return true; }
                    return false;
   });
});

}



    function fnInitForm(type){
       $('#formtable').dataTable({
            "fnCreatedRow": function( nRow, aData, iDataIndex ) {
                                $('td:eq(0)', nRow).html( '<img class="details_img" src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/images/details_open.png')}">' );
                                
            },
            "aoColumnDefs": [
                                { "aTargets":[ "Approval_Status" ], "mData": "Approval_Status__c" },
                                { "aTargets":[ "level" ],"mData": "Approval_Level__c"},
                                { "aTargets":[ "appr" ],"mData": "Approver__r.Name" },
                                { "aTargets":[ "type" ],"mData": "Type__c" },
                                { "aTargets":[ "sold" ],"mData": "SAP_SoldTo_Account__c" },
                                { "aTargets":[ "ship" ],"mData": "SAP_ShipTo_Account__c" },
                                { "aTargets":[ "mat" ],"mData": "SAP_Material__r.Name" },
                                { "aTargets":[ "start" ],"mData": "Requested_Effective_Date_Text__c"},
                                { "aTargets":[ "end" ],"mData": "Requested_Expiration_Date_Text__c" },
                                { "aTargets":[ "vol" ],"mData": "Volume__c"},
                                { "aTargets":[ "voluom" ],"mData": "Requested_UoM__c" },
                                { "aTargets":[ "price" ],"mData": "Price__c" },
                                { "aTargets":[ "priceuom" ],"mData": "Requested_Price_UoM__c"},
                                { "aTargets":[ "TPI" ], 
                                      "mData": function ( source, type, val ) {
                                          if (type === 'set') {
                                              return;
                                          }
                                          else if (type === 'display') { 
                                            if((typeof source.TPI__c == 'undefined') || source.TPI__c == null)
                                              return '';
                                            else 
                                              return (source.TPI__c + '%');
                                          }
                                          return source.TPI__c;
                                      }
                                },
                                { "aTargets":[ "Inner_Table" ],"mData": "Inner_Table__c", sWidth:"2px", "bVisible":false}
                         ]
            
            });
            
    
           var uoms = new Array();
           $('#brpriceuom').find('option').each(function(i, opt){ uoms.push($(opt).val()); });
           
           $.ech.multiselect.prototype.options.minWidth = "auto";
           $('.easyui-combo').combobox({editable:false, panelHeight: 'auto'});
           $('#priceprot').combobox({editable:false});
         
           $('#currencies').combobox('disable');
           $('#pricetype').combobox('disable');
           $('#priceprot').combobox('disable');
           $('#drumdep').combobox('disable');
                      
           $('#currencies').combobox('setValue', $('#currencies').attr('data-value'));
           $('.uom').each(function(i, u){ if(jQuery.inArray($(u).attr('data-value'), uoms) > -1){ $(u).combobox('setValue',  $(u).attr('data-value')); } });
           
           $('.easyui-linkbutton').linkbutton({plain:true});
           $('#SaveSubmit').linkbutton('disable');
           $( "#edate" ).datepicker({ minDate: 0, required:true , editable:false });
           $( "#exdate" ).datepicker({ minDate: 0, maxDate: "+1Y", required:true, editable:false  });
           $( "#edate" ).change(function() {
                      var date = new Date($(this).val());
                      var d = date.getDate();
                      var m = date.getMonth();
                      var y = date.getFullYear();
                      var newdate = new Date(y+1, m, d);          
                      $( "#exdate" ).datepicker( "option" ,{ minDate: date, maxDate: newdate, required:true  });
                      $( "#exdate" ).datepicker( "setDate" , newdate );
                      $( "#edate" ).validatebox("validate"); 
                      $( "#exdate" ).validatebox("validate"); 
           });
           
           
             $('.addRow').click(function(){ fnAddRow(); });
            $('.removeRow').click(function(){
                  $(this).parent().parent().remove();
                  $('.bracketcontainer').each(function(i, bc){
                     $(this).find('.bracketvolume').attr('name', 'bracketvolume_' + i);
                     $(this).find('.bracketprice').attr('name', 'bracketprice_' + i);
                  });
                  console.log($('.bracketcontainer').size());
                  $('.bracketprice').each(function(){ console.log($(this).attr('name')); });
               });
               
           $('#Competitors').combogrid({  
                panelWidth:200, 
                width:200, 
                value:'',    
                delay: 500,  
                idField:'Id',  
                textField:'Name', 
                required: true,
                keyHandler: {
                  query: function(q){
                          var g = $(this).combogrid('grid');
                          Price_Req_Coord_Controller.getComboGridData(q, 'Nexeo_Competitor__c', 'Name', 'status__c = \'Active\' and Competitor_or_Supplier__c = \'Competitor\'', 'Name ASC', '1000', function(result, event){
                            if(event.type == 'exception') {
                              error.apply(this, arguments);         
                            } else {      
                              g.datagrid('loadData', result);         
                            }
                          });
                   }
                },
                columns:[[  
                       {field:'Name',title:'Name',width:300} 
                ]],
                loader: function(param,success,error){
                    Price_Req_Coord_Controller.getComboGridData('', 'Nexeo_Competitor__c', 'Name', 'status__c = \'Active\' and Competitor_or_Supplier__c = \'Competitor\'', 'Name ASC', '1000', function(result, event){
        
                     if(event.type == 'exception') {
                        error.apply(this, arguments);         
                     } else {      
                       success(result);         
                     }
                 });
                },
                onSelect: function(param){ fixEscapedHTML($('#Competitors').combogrid('getText'), 'Competitors'); }
            });
           
           $('#Competitors').combogrid('textbox').focusin(function(){ 
           $('#Competitors').combogrid('clear');
             });
           $('#Competitors').combogrid('setValue', $('#Competitors').attr('data-compid'));
           fixEscapedHTML($('#Competitors').attr('data-compname'), 'Competitors');
           $('#Competitors').combobox('disable');
        
        
           $('#edate').keyup(function(){ $(this).val('')});
           $('#exdate').keyup(function(){ $(this).val('')});
           $('#exdate').datepicker( "hide" );
           
            $('#Competitors').combobox('disable');
            $('#obtainedfrom').combobox('disable');
            $('#compuom').combobox('disable');
         
           
            
            
            $('#CancelForm').click(function() {
                $('#loadtarget').empty();
               });
               
             $( "#Simulate" ).click(function() {
                   
                 $('#formtype').val('simulate');
                 if(fnValidateCreateForm() == true){
                   $('#createform').submit();
                   $('#SaveSubmit').linkbutton('enable');
                 }
                    
             });
               
            $( "#SaveSubmit" ).click(function() {
                
                    $('#formtype').val('savesubmit');
                    if(fnValidateCreateForm() == true){
                      $('#createform').submit();
                      $('#loadtarget').empty();
                      oTable = $('#pendingentry').dataTable();
                      oTable.fnClearTable();
                      fnfetchPendingEntry();
                    }
                 
            });
     }
     function fnValidateCreateForm(){
  
          var isValid;
          if($('#Competitors').combobox('getValue') != '')
          { $('#CompetitorsFrame').removeClass('error');
            $('#CompetitorsError').html('');
          }
          else
          { $('#CompetitorsFrame').addClass('error');
            $('#CompetitorsError').html('This field is required.');
          }
          if($("#createform").valid() == true && $('#Competitors').combobox('getValue') != '')
             return true;
          else
             return false;
     }
     
     function startSimulate(formData, Operation){
     
         var oTable = $('#pendingentry').dataTable();
         var sData = new Array();
         oTable.$('input:checked').each(function(i, sel){ sData.push($(sel).val()); });
         oTable = $('#formtable').dataTable();
         oTable.fnClearTable();
         Price_Req_Coord_Controller.SimulateForm(sData, formData, Operation, function(result, event){
            
             if(event.type == 'exception') {
                 console.log('exception');  
                 console.log(event);   
                 alert(event.message);    
             }
             else{ 
                    if(Operation == 'simulate'){
                        if(result.length > 0){  
                            oTable.fnClearTable();
                            oTable.fnAddData(result);
                            console.log(result);
                        }
                    }
                
             }
             return false;
         });
    }
    
    
    $('#formtable tbody td img, .formtable tbody td img').live('click', function () {
            var nTr = this.parentNode.parentNode;
            oTable = $(nTr.parentNode.parentNode).dataTable();
            var iRows = oTable.fnSettings().fnRecordsTotal();
            var iHeight = oTable.fnSettings().oScroll.sY;
            if ( this.src.match('details_close') )
            {
                this.src = "{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/images/details_open.png')}";
                oTable.fnClose( nTr );
                iHeight = iHeight -125;
            }
            else
            {
                this.src = "{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/images/details_close.png')}";
                oTable.fnOpen( nTr, fnFormatDetails(oTable, nTr), 'details' ); 
                $('.innerTable').dataTable({
                "bDestroy": true,
                "bPaginate": false,
                "bLengthChange": false,
                "bFilter": false,
                "bSort": false,
                "bInfo": false
                });
                iHeight = iHeight + 125;
            }

                      if(iHeight >= 75 && iHeight < 400 && oTable.fnSettings().oScroll.sY < 400)
                      {  oTable.fnSettings().oScroll.sY = iHeight;
                         $(oTable).parent().height(iHeight);
                      }
                      if(iHeight > 400 || oTable.fnSettings().oScroll.sY > 400)
                      {
                         oTable.fnSettings().oScroll.sY = 400;
                         $(oTable).parent().height(400);
                      }
        } );
        
        
        function fnAddRow(){
  
              var count = $('.bracketcontainer').size();
              console.log('row count: ' + count);
              var newRow = '<tr class="bracketcontainer" style="height:10px;"><td style="vertical-align:top;padding-right:1px;">';
              newRow += '<input class="bracketvolume combo required number" name="bracketvolume_'+ (count)+ '" style="width:100px;height:20px;" />';
              newRow += '<br/><div class="error_container"/></td><td></td><td style="vertical-align:top;padding-right:1px;"><input class="bracketprice combo required number" name="bracketprice_'+ (count)+ '" style="height:20px;"/>';
              newRow += '<br/><div class="error_container"/></td><td></td><td><img class="removeRow" src="{!URLFOR($Resource.JQuery_Pricing, '/JQuery_Pricing/images/details_close.png')}"/><b>&nbsp;Remove</b></td></tr>';

              
              $('#brackettable').append(newRow);
              $('.bracketprice').each(function(){ console.log($(this).attr('name')); });
              $('.removeRow').click(function(){
                  $(this).parent().parent().remove();
                  $('.bracketcontainer').each(function(i, bc){
                     $(this).find('.bracketvolume').attr('name', 'bracketvolume_' + i);
                     $(this).find('.bracketprice').attr('name', 'bracketprice_' + i);
                  });
                  console.log($('.bracketcontainer').size());
                  $('.bracketprice').each(function(){ console.log($(this).attr('name')); });
               });    
            }
    
</script>
</apex:outputpanel>

<style>
label.error {
    color: red;
}
div.error{
border-style:solid;
border-width:1.5px;
border-color:red;
}
input.error{
border-style:solid;
border-color:red;
}
select.error{
border-style:solid;
border-color:red;
}
input:disabled{ background-color:LightGray}
textarea:disabled{ background-color:LightGray}      
textarea { padding: 5px; width: 400px; }
#ff label{
     display:block;
     width:100px;
}
#button { padding: .5em 1em; text-decoration: none; }
#effect { padding: 0.4em; position: relative; }
.ui-menu { position: absolute; }
tbody tr.even:hover,  tbody tr.even td.highlighted {
    background-color: #ECFFB3;
}
tbody tr.odd:hover,  tbody tr.odd td.highlighted {
    background-color: #E6FF99;
}
tr.even:hover {
    background-color: #ECFFB3;
}
tr.even:hover td.sorting_1 {
    background-color: #DDFF75;
}
tr.even:hover td.sorting_2 {
    background-color: #E7FF9E;
}
tr.even:hover td.sorting_3 {
    background-color: #E2FF89;
}
tr.odd:hover {
    background-color: #E6FF99;
}
tr.odd:hover td.sorting_1 {
    background-color: #D6FF5C;
}
tr.odd:hover td.sorting_2 {
    background-color: #E0FF84;
}
tr.odd:hover td.sorting_3 {
    background-color: #DBFF70;
}
table.viewtable tr.even.row_selected td {
    background-color: #B0BED9;
}
table.viewtable tr.odd.row_selected td {
    background-color: #9FAFD1;
}
table.gridtable {
    font-family: verdana,arial,sans-serif;
    font-size:11px;
    color:#333333;
    border-width: 1px;
    border-color: #666666;
    border-collapse: collapse;
}
table.gridtable th {
    border-width: 1px;
    padding: 8px;
    border-style: solid;
    border-color: #666666;
    background-color: #dedede;
}
table.gridtable td {
    border-width: 1px;
    padding: 8px;
    border-style: solid;
    border-color: #666666;
    background-color: #ffffff;
}
</style>
<input type="hidden" id="apprids"/>
<apex:form id="actionform">
<apex:actionStatus id="EnhancedStatus">
<apex:facet name="start">
<c:EnhancedActionStatus BackColor="#efefef" borderColor="#336699" borderSize="3" height="20px" width="100px" ImageUrl="{!$Resource.spinner}" Message="Loading..." messageStyle="color:darkred;font-size:11pt;font-weight:bold;"/>
</apex:facet>
</apex:actionStatus>
</apex:form>

<div id="toolbar" style="padding:5px;width:1400px;">
        <a href="javascript:void(0)" id="sb1" class="easyui-splitbutton" data-options="menu:'#mm1',iconCls:'icon-edit'">Menu</a>
</div>
    <div id="mm1" style="width:150px;">
        <div id="rejectInfo" >Update Info</div>
        <div id="SelectAll">Select All</div>
        <div id="ClearFilters">Clear Filters</div>
        <div id="closerecords">Close Records</div>
        <div id="Reset">Deselect All</div>
    </div>
     
  <table><tr><td>
  <table style="width:1200px;" class="viewtable display" id="pendingentry">
  <thead>
  <tr>
  <th class="Open" rowspan="2">Open</th>
  <th class="Select" rowspan="2">Select</th>
  <th  ><input class="textinput" placeholder="Transaction" data-field="Name"/></th>
  <th  ><input class="textinput" placeholder="CAM" data-field="Ship_To__r.SAP_Corporate_Account_Manager__r.Name"/></th>
  <th  ><input class="textinput" placeholder="Corporate" data-field="SAP_Corporate_Account__c"/></th>
  <th  ><input class="textinput" placeholder="Sold To" data-field="SAP_SoldTo_Account__c"/></th>
  <th  ><input class="textinput" placeholder="Ship To" data-field="SAP_ShipTo_Account__c"/></th>
  <th  ><input class="textinput" placeholder="Sales Org" data-field="Sales_Org_Code_and_Desc__c"/></th>
  <th  ><input class="textinput" placeholder="DM (Ship To)" data-field="Ship_To__r.SAP_Sales_Group_Desc__c"/></th>
  <th  ><input class="textinput" placeholder="Ship to Seller" data-field="Ship_To__r.Owner.Name"/></th>
  <th  ><input class="textinput" placeholder="Material" data-field="SAP_Material__r.Name"/></th>
  <th  ><input class="textinput" placeholder="Eff Date (Y-M-D)" data-field="Requested_Effective_Date__c"/></th>
  <th  ><input class="textinput" placeholder="Exp Date (Y-M-D)" data-field="Requested_Expiration_Date__c"/></th>
  <th  ><input class="textinput" placeholder="Volume" data-field="Volume__c"/></th>
  <th  ><input class="textinput" placeholder="UoM" data-field="Requested_UoM__c"/></th>
  <th  ><input class="textinput" placeholder="Price" data-field="Price__c"/></th>
  <th  ><input class="textinput" placeholder="UoM" data-field="Requested_Price_UoM__c"/></th>
  <th  ><input class="textinput" placeholder="Price Protection" data-field="Requested_Price_Protection__c"/></th>
  <th  ><input class="textinput" placeholder="Comments" data-field="Comments__c"/></th>
  <th  ><input class="textinput" placeholder="Approval Comments" data-field="Approval_Rejection_Comments__c"/></th>
  <th >Id</th>
  <th >Inner Table</th>
  </tr>
  
  <tr>
  <th class="Transaction">Transaction</th>
  <th class="Corporate_Owner">CAM</th>
  <th class="Corporate">Corporate</th>
  <th class="Sold_To">Sold To</th>
  <th class="Ship_To">Ship To</th>
  <th class="Sales_Org">Sales Org</th>
  <th class="Sales_Group">DM (Ship To)</th>
  <th class="Ship_To_Seller">Ship to Seller</th>
  <th class="Material">Material</th>
  <th class="Eff_Date">Eff Date (Y-M-D)</th>
  <th class="Exp_Date">Exp Date (Y-M-D)</th>
  <th class="Volume">Volume</th>
  <th class="Requested_UoM">UoM</th>
  <th class="Price">Price</th>
  <th class="Requested_Price_UoM">UoM</th>
  <th class="Requested_Price_Protection">Price Protection</th>
  <th class="Comments">Comments</th>
  <th class="Approval_Rejection_Comments">Approval Comments</th>
  <th class="Id">Id</th>
  <th class="Inner_Table">Inner Table</th>
  </tr>
  </thead>
  <tbody></tbody>
  </table>
  </td></tr><tr><td>
    <div id="loadtarget"></div>
    </td></tr></table>

</apex:page>